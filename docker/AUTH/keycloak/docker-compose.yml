services:
  keycloak:
    container_name: keycloak

    # Keycloak 최신 안정 버전 (2025 기준)
    image: quay.io/keycloak/keycloak:26.4.6

    # 운영 모드로 실행 (❌ start-dev 아님)
    command: start
    ports:
      # 내부/프록시 연동용 HTTP
      - "8080:8080"
      # (직접 HTTPS를 쓸 경우만 필요)
      - "8443:8443"

    environment:
      # -----------------------------
      # 관리자 계정 (초기 1회 생성)
      # -----------------------------
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: Admin2580!

      # -----------------------------
      # 데이터베이스 설정 (운영 필수)
      # -----------------------------
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloakpass

      # -----------------------------
      # 프록시 환경 설정
      # (Nginx Proxy Manager 사용 시 필수)
      # -----------------------------
      KC_PROXY: edge
      KC_HTTP_ENABLED: true
      KC_HTTP_PORT: 8080

      # 외부에서 접근하는 도메인
      # (토큰 issuer, redirect URI 생성에 사용됨)
      KC_HOSTNAME: auth.itapi.org

      # -----------------------------
      # 운영 환경 권장 옵션
      # -----------------------------
      KC_LOG_LEVEL: INFO
      KC_HEALTH_ENABLED: true
      KC_METRICS_ENABLED: true
      
    depends_on:
      - postgres

    # 컨테이너 재시작 정책
    restart: unless-stopped

  # ===============================
  # PostgreSQL (Keycloak 전용 DB)
  # ===============================
  postgres:
    container_name: keycloak-postgres
    image: postgres:18-alpine
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloakpass
    volumes:
      # DB 데이터 영속화 (컨테이너 재시작 시 데이터 유지)
      - /APP/keycloak/kc_pgdata:/var/lib/postgresql/data
    restart: unless-stopped
