services:
  keycloak:
    container_name: keycloak

    # Keycloak ìµœì‹  ì•ˆì • ë²„ì „ (2025 ê¸°ì¤€)
    image: quay.io/keycloak/keycloak:26.4.6

    # ìš´ì˜ ëª¨ë“œë¡œ ì‹¤í–‰ (âŒ start-dev ì•„ë‹˜)
    command: start
    ports:
      # ë‚´ë¶€/í”„ë¡ì‹œ ì—°ë™ìš© HTTP
      - "8080:8080"
      # (ì§ì ‘ HTTPSë¥¼ ì“¸ ê²½ìš°ë§Œ í•„ìš”)
      - "8443:8443"

    environment:
      # -----------------------------
      # ê´€ë¦¬ì ê³„ì • (ì´ˆê¸° 1íšŒ ìƒì„±)
      # -----------------------------
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: Admin2580!

      # -----------------------------
      # ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • (ìš´ì˜ í•„ìˆ˜)
      # -----------------------------
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloakpass

      # -----------------------------
      # í”„ë¡ì‹œ í™˜ê²½ ì„¤ì •
      # (Nginx Proxy Manager ì‚¬ìš© ì‹œ í•„ìˆ˜)
      # -----------------------------
      KC_PROXY: edge
      KC_HTTP_ENABLED: true
      KC_HTTP_PORT: 8080

      # ì™¸ë¶€ì—ì„œ ì ‘ê·¼í•˜ëŠ” ë„ë©”ì¸
      # (í† í° issuer, redirect URI ìƒì„±ì— ì‚¬ìš©ë¨)
      KC_HOSTNAME: auth.itapi.org

      # -----------------------------
      # ìš´ì˜ í™˜ê²½ ê¶Œì¥ ì˜µì…˜
      # -----------------------------
      KC_LOG_LEVEL: INFO
      KC_HEALTH_ENABLED: true
      KC_METRICS_ENABLED: true

      # Realm ìë™ import
      KC_IMPORT: /opt/keycloak/data/import

    volumes:
      # ğŸ¨ ì»¤ìŠ¤í…€ í…Œë§ˆ
      - /APP/keycloak/themes:/opt/keycloak/themes

      # ğŸ”Œ ì»¤ìŠ¤í…€ Provider (SPI)
      - /APP/keycloak/providers:/opt/keycloak/providers

      # ğŸ“¦ Realm import/export
      - /APP/keycloak/import:/opt/keycloak/data/import
      
    depends_on:
      - postgres

    # ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ ì •ì±…
    restart: unless-stopped

  # ===============================
  # PostgreSQL (Keycloak ì „ìš© DB)
  # ===============================
  postgres:
    container_name: keycloak-postgres
    image: postgres:18-alpine
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloakpass
    volumes:
      # DB ë°ì´í„° ì˜ì†í™” (ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ ì‹œ ë°ì´í„° ìœ ì§€)
      - /APP/keycloak/kc_pgdata:/var/lib/postgresql
    restart: unless-stopped
