services:
  # ==========================================
  # 1. Backend
  # ==========================================
  logforge-backend:
    image: madanb13/logforge-backend:latest
    container_name: logforge-backend
    restart: unless-stopped
    environment:
      # [수정] 변수 누락 방지를 위해 직접 할당
      - VITE_NOTIFIER_PORT=8087
      - VITE_ALERT_ENGINE_PORT=3033
    volumes:
      - logforge_core_data:/app/app/core/data
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - logforge-network
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # ==========================================
  # 2. Frontend (메인 접속: 3008 포트)
  # ==========================================
  logforge-frontend:
    image: madanb13/logforge-frontend:latest
    container_name: logforge-frontend
    restart: unless-stopped
    ports:
      - "3008:3000"
    environment:
      # [수정] 프론트엔드가 알림/경고 엔진을 찾을 수 있도록 포트 명시
      - VITE_NOTIFIER_PORT=8087
      - VITE_ALERT_ENGINE_PORT=3033
    depends_on:
      - logforge-backend
    networks:
      - logforge-network
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # ==========================================
  # 3. Notifier (알림 발송)
  # ==========================================
  logforge-notifier:
    image: madanb13/logforge-notifier:latest
    container_name: logforge-notifier
    restart: unless-stopped
    ports:
      - "8087:8085"
    volumes:
      - logforge_notifier_data:/app/data
      - /etc/localtime:/etc/localtime:ro
    networks:
      - logforge-network
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # ==========================================
  # 4. Auto Update (오류 수정됨)
  # ==========================================
  logforge-autoupdate:
    image: madanb13/logforge-autoupdate:latest
    container_name: logforge-autoupdate
    restart: always
    environment:
      # [핵심 수정] 호스트 도커 API 버전 오류 해결
      - DOCKER_API_VERSION=1.44
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # ==========================================
  # 5. Alert Engine Backend
  # ==========================================
  alert-engine-backend:
    image: madanb13/logforge-alert-backend:latest
    container_name: logforge-alert-backend
    restart: unless-stopped
    volumes:
      - logforge_alert_engine_data:/app/data
    healthcheck:
      test: ["CMD", "/app/alert_engine", "--selfcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      - logforge-backend
      - logforge-notifier
    networks:
      - logforge-network
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # ==========================================
  # 6. Alert Engine Frontend
  # ==========================================
  alert-engine-frontend:
    image: madanb13/logforge-alert-frontend:latest
    container_name: logforge-alert-frontend
    restart: unless-stopped
    ports:
      - "3033:3033"
    environment:
      - ALERT_ENGINE_FRONTEND_PORT=3033
    depends_on:
      alert-engine-backend:
        condition: service_healthy
    networks:
      - logforge-network
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

networks:
  logforge-network:
    driver: bridge

volumes:
  logforge_core_data:
  logforge_notifier_data:
  logforge_alert_engine_data:
